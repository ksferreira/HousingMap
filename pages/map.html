<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Housing Map</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">HousingMap</div>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search location...">
        </div>
        <div class="nav-links">
            <a href="../index.html" class="nav-btn">Home</a>
            <a href="../pages/about.html" class="nav-btn">About</a>
            <a href="#" class="nav-btn">Contact</a>
        </div>
    </nav>

    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Location Details</h2>
            </div>
            <div class="sidebar-content">
                <div class="info-card">
                    <h3 id="city-county">Selected Area</h3>
                    <p>No area selected</p>
                </div>
                <div class="info-card">
                    <h3>Statistics</h3>
                    <p>Loading...</p>
                </div>
                <div class="info-card">
                    <h3>Recent Searches</h3>
                    <ul>
                        <li>New York, NY</li>
                        <li>Los Angeles, CA</li>
                        <li>Chicago, IL</li>
                    </ul>
                </div>
            </div>
        </aside>

        <main class="map-container">
            <div class="map" id="map">
                <!-- Map will be embedded here -->
            </div>
        </main>
    </div>
    <script> 
        document.addEventListener('DOMContentLoaded', function() {
            const map = L.map('map').setView([40.7128, -74.0060], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const searchInput = document.querySelector('.search-input');

            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'search-suggestions';
            searchInput.parentNode.appendChild(suggestionsContainer);

            async function searchLocation(query) {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&featuretype=city&limit=1`);
                const data = await response.json();
                return data;
            }

            let timeout;

            searchInput.addEventListener('input', function() {
                
                if (timeout) clearTimeout(timeout);

                const query = this.value;
                if (query.length < 2) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                timeout = setTimeout(async () => {
                    try {   
                        const suggestions = await searchLocation(query);
                        suggestionsContainer.innerHTML = ''
                        
                        if (suggestions.length > 0) {
                            suggestionsContainer.style.display = 'block';

                            suggestions.forEach(result => {
                                const div = document.createElement('div');
                                div.className = 'suggestion-item';
                                div.textContent = result.display_name;
                                div.addEventListener('click', async () => {
                                    searchInput.value = result.display_name;
                                    suggestionsContainer.style.display = 'none';

                                    const latlng = [parseFloat(result.lat), parseFloat(result.lon)];
                                    window.searchMarker = L.marker(latlng).addTo(map);

                                    try {
                                        const response = await fetch(`https://nominatim.openstreetmap.org/lookup?osm_ids=${result.osm_type[0].toUpperCase()}${result.osm_id}&format=geojson&polygon_geojson=1&admin_level=8`);
                                        const geojsonData = await response.json();
                                        
                                        const selectedAreaCard = document.querySelector('.info-card:first-child p');

                                        selectedAreaCard.innerHTML = `
                                            <strong>Location:</strong> ${result.display_name}<br>
                                            <strong>Type:</strong> ${geojsonData.type}<br>
                                            <strong>Properties:</strong> ${JSON.stringify(geojsonData.properties, null, 2)}
                                        `;

                                        if (window.geojsonLayer) {
                                            map.removeLayer(window.geojsonLayer);
                                        }
                                        window.geojsonLayer = L.geoJSON(geojsonData, {
                                            style: function(feature) {
                                                return {
                                                    color: '#3388ff',
                                                    weight: 2,
                                                    opacity: 1,
                                                    fillOpacity: 0.2,
                                                    fillColor: '#3388ff'
                                                };
                                            },
                                            onEachFeature: function(feature, layer) {
                                                if (feature.properties && feature.properties.name) {
                                                    layer.bindPopup(feature.properties.name);
                                                }
                                            }
                                        }).addTo(map);

                                        map.fitBounds(window.geojsonLayer.getBounds());
                                    } catch (error) {
                                        console.error('Error fetching GeoJSON:', error);
                                    }
                                });

                                suggestionsContainer.appendChild(div);
                            });
                        } else {
                            suggestionsContainer.innerHTML = '<div class="no-results">No results found</div>';
                        }
                    } catch (error) {
                        console.error('Error searching location:', error);
                    }
                }, 300);
            });
            
            
        });
    </script>
</body>
</html>
